<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моделирование последствий выбросов химически опасных веществ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            margin-left: 30px;
            margin-right: 30px;
        }

        .scrollable-table-1 {
            width: 30%;
            height: 860px;
            overflow: hidden auto;
        }

        .scrollable-table-2 {
            width: 30%;
            height: 860px;
            overflow: hidden auto;
        }

        .scrollable-table-3 {
            width: 40%;
            height: 860px;
            overflow: hidden auto;
        }

        .data-table-1 {
            height: 800px;
        }

        .data-table-2 {
            height: 800px;
        }

        .data-table-3 {
            height: 800px;
        }

        .tables {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        sup {
            margin-bottom: 15px;
        }

        sub {
            margin-top: 15px;
        }

        table {
            overflow: auto;
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        caption {
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px;
            background-color: #4fc3ee;
            color: white;
        }

        th, td {
            padding: 10px 15px;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f8f8f8;
            font-weight: bold;
        }

        td input[type="number"] {
            padding: 5px;
            width: 80px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            text-align: center;
        }

        td input[type="number"]:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .equation{
            display: flex;
            row-gap: 10px;
            flex-wrap: wrap;
            align-items: center
        }

        button {
            background-color: #4fc3ee;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            flex: 1;
        }

        #results{
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .result-item {
            width: 100%;
            padding: 10px;
            display: flex;
            flex-direction: row;
            gap: 40px;
            border-radius: 20px;
        }

        .result-item img {
            flex: 1;
            height: auto;
            min-width: 0;
            max-width: 100%;
            border-radius: 10px;
        }

        #random{
            background-color: #4fc3ee;
        }

        #random:hover{
            background-color: #3689a6;
        }

        button:hover {
            background-color: #3689a6;
        }

        button:active {
            transform: scale(0.98);
        }

        .secondary-column {
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Добавляем прокрутку */
            margin-top: 10px;
            margin-bottom: 10px;
        }

        #calculate {
            background-color: #4fc3ee;
        }

        #calculate:hover {
            background-color: #3689a6;
        }

        div {
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            table {
                width: 90%;
                margin: 10px auto;
            }

            button {
                width: auto;
            }

            div {
                margin-right: 0;
            }
        }
    </style>
</head>

<body>

    <div class="tables">
        <div class="scrollable-table-1">
            <table class="data-table-1">
                <caption>Исследуемые показатели</caption>
                <thead>
                <tr>
                    <th>Название параметра</th>
                    <th>Значение</th>
                    <th>Предел</th>
                    <th>Норм. знаменатель</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Время испарения ОХВ в районе аварии с пов. земли</td>
                    <td><input type="number" name="" id="L1"></td>
                    <td><input type="number" name="" id="L1_max"></td>
                    <td><input type="number" name="" value="0.7" id="L1_norm"></td>
                </tr>
                <tr>
                    <td>Время ликвидации последствий аварии на ХОО</td>
                    <td><input type="number" name="" id="L2"></td>
                    <td><input type="number" name="" id="L2_max"></td>
                    <td><input type="number" name="" value="0.7" id="L2_norm"></td>
                </tr>
                <tr>
                    <td>Площадь заражения в результате аварии</td>
                    <td><input type="number" name="" id="L3"></td>
                    <td><input type="number" name="" id="L3_max"></td>
                    <td><input type="number" name="" value="0.7" id="L3_norm"></td>
                </tr>
                <tr>
                    <td>Время подхода первичного/вторичного облака к НП</td>
                    <td><input type="number" name="" id="L4"></td>
                    <td><input type="number" name="" id="L4_max"></td>
                    <td><input type="number" name="" value="0.7" id="L4_norm"></td>
                </tr>
                <tr>
                    <td>Потери от первичного облака</td>
                    <td><input type="number" name="" id="L5"></td>
                    <td><input type="number" name="" id="L5_max"></td>
                    <td><input type="number" name="" value="0.7" id="L5_norm"></td>
                </tr>
                <tr>
                    <td>Потери от вторичного облака</td>
                    <td><input type="number" name="" id="L6"></td>
                    <td><input type="number" name="" id="L6_max"></td>
                    <td><input type="number" name="" value="0.7" id="L6_norm"></td>
                </tr>
                <tr>
                    <td>Количество получивших амбулаторную помощь (чел.)</td>
                    <td><input type="number" name="" id="L7"></td>
                    <td><input type="number" name="" id="L7_max"></td>
                    <td><input type="number" name="" value="0.7" id="L7_norm"></td>
                </tr>
                <tr>
                    <td>Количество размещенных в стационаре и реанимации (чел.)</td>
                    <td><input type="number" name="" id="L8"></td>
                    <td><input type="number" name="" id="L8_max"></td>
                    <td><input type="number" name="" value="0.7" id="L8_norm"></td>
                </tr>
                <tr>
                    <td>Количество поражённой техники</td>
                    <td><input type="number" name="" id="L9"></td>
                    <td><input type="number" name="" id="L9_max"></td>
                    <td><input type="number" name="" value="0.7" id="L9_norm"></td>
                </tr>
                <tr>
                    <td>Количество объемов и растворов для обеззараживания местности</td>
                    <td><input type="number" name="" id="L10"></td>
                    <td><input type="number" name="" id="L10_max"></td>
                    <td><input type="number" name="" value="0.7" id="L10_norm"></td>
                </tr>
                <tr>
                    <td>Количество сил и средств для проведения авар.-спасательных работ</td>
                    <td><input type="number" name="" id="L11"></td>
                    <td><input type="number" name="" id="L11_max"></td>
                    <td><input type="number" name="" value="0.7" id="L11_norm"></td>
                </tr>
                <tr>
                    <td>Эффективность системы оповещения</td>
                    <td><input type="number" name="" id="L12"></td>
                    <td><input type="number" name="" id="L12_max"></td>
                    <td><input type="number" name="" value="0.7" id="L12_norm"></td>
                </tr>
                <tr>
                    <td>Количество людей в зоне поражения</td>
                    <td><input type="number" name="" id="L13"></td>
                    <td><input type="number" name="" id="L13_max"></td>
                    <td><input type="number" name="" value="0.7" id="L13_norm"></td>
                </tr>
                <tr>
                    <td>Количество спасателей в зоне поражения</td>
                    <td><input type="number" name="" id="L14"></td>
                    <td><input type="number" name="" id="L14_max"></td>
                    <td><input type="number" name="" value="0.7" id="L14_norm"></td>
                </tr>
                <tr>
                    <td>Развитость системы МЧС</td>
                    <td><input type="number" name="" id="L15"></td>
                    <td><input type="number" name="" id="L15_max"></td>
                    <td><input type="number" name="" value="0.7" id="L15_norm"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="scrollable-table-2">
            <table class="data-table-2">
                <caption>Возмущения</caption>
                <tbody id="disturbancesTable">
                <!-- Строки возмущений будут генерироваться здесь -->
                </tbody>
            </table>
        </div>
        <div class="scrollable-table-3">
            <table class="data-table-3">
                <caption>Уравнения</caption>
                <tbody id="equationsTable">
                <!-- Строки уравнений будут генерироваться здесь -->
                </tbody>
            </table>
        </div>

    </div>

    <div class="button-div">
        <div class="button-group" style="margin-top: 5px; display: flex; gap: 50px;">
            <button id="random">Заполнить случайными переменными</button>
            <button id="saveValuesToJson">Сохранить значения</button>
            <button id="loadValuesFromJson">Загрузить значения</button>
            <button id="calculate">Вычислить результат</button>
        </div>
        <h1 class="results-title" style="margin-top: 20px; margin-bottom: 10px;">Полученный результат:</h1>
        <div id="results" class="results-container">
            <!-- Здесь будут отображаться графики -->
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const resultDiv = document.getElementById("results");

            // Получаем результаты из localStorage
            const savedResults = JSON.parse(localStorage.getItem("savedResults")) || { results: [] };

            // Перебираем результаты в обратном порядке и добавляем их в DOM
            savedResults.results.reverse().forEach(result => {
                const resultItem = `
                    <div class="result-item">
                        <img src="data:image/png;base64,${result.img1}" alt="График 1">
                        <img src="data:image/png;base64,${result.img2}" alt="График 2">
                    </div>
                `;
                resultDiv.innerHTML += resultItem;
            });
        });
    </script>
    <script>
        const numberOfDisturbances = 5; // Количество возмущений
        const numberOfEquations = 55; // Количество уравнений

        async function loadVariables() {
            try {
                // Fetch JSON from the server
                const response = await fetch('/get-json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.functionsInfo;
            } catch (error) {
                console.error('Error loading JSON:', error);
                return [];
            }
        }

        async function generateEquations() {
            const equationsTable = document.getElementById('equationsTable');

            const functionsInfo = await loadVariables();

            functionsInfo.forEach((func, index) => {
                const row = document.createElement('tr');

                row.innerHTML = `
                    <td class="equation">
                        f<sub>${index + 1}</sub> = <input type="number" id="a${index + 1}">K<sub>${func.variable}</sub>(t)<sup>3</sup> +
                        <input type="number" id="b${index + 1}">K<sub>${func.variable}</sub>(t)<sup>2</sup> +
                        <input type="number" id="c${index + 1}">K<sub>${func.variable}</sub>(t) +
                        <input type="number" id="d${index + 1}">
                    </td>
                `;
                equationsTable.appendChild(row);
            });
        }

        function generateDisturbances() {
            const disturbanceTable = document.getElementById('disturbancesTable');

            function disturbanceTemplate(title, seq) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="disturbance">
                        <h4 style="margin-bottom: 20px; font-weight: 500">${title}</h3>
                        R<sub>${seq}</sub> = <input type="number" id="qa${seq}">t<sup>3</sup> +
                        <input type="number" id="qb${seq}">t<sup>2</sup> +
                        <input type="number" id="qc${seq}">t +
                        <input type="number" id="qd${seq}">
                    </td>
                `;
                disturbanceTable.appendChild(row);
            }
            disturbanceTemplate("Уровень финансирования системы МЧС города", 1);
            disturbanceTemplate("Степень экономического развития города", 2);
            disturbanceTemplate("Степень экономического развития города", 3);
            disturbanceTemplate("Доля современного оборудования на предприятии", 4);
        }

        // Генерируем строки уравнений при загрузке страницы
        document.addEventListener('DOMContentLoaded', generateEquations);
        document.addEventListener('DOMContentLoaded', generateDisturbances);
    </script>
    <script>
        document.getElementById("random").addEventListener("click", randomizeValues);
        function randomizeValues() {
            const zeroChance = parseFloat(0.9);

            function getRandomValue() {
                return Math.random();
            }

            function getConditionalRandom() {
                return Math.random() > zeroChance ? getRandomValue() : 0.0;
            }

            for (let i = 1; i <= 15; i++) {
                let randVal = getRandomValue().toFixed(2);
                document.getElementById(`L${i}`).value = randVal;
                document.getElementById(`L${i}_max`).value = randVal * 1.25;
            }

            for (let i = 1; i <= 4; i++) {
                document.getElementById(`qa${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`qb${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`qc${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`qd${i}`).value = getConditionalRandom().toFixed(2)
            }

            for (let i = 1; i <= 55; i++) {
                document.getElementById(`a${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`b${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`c${i}`).value = getConditionalRandom().toFixed(2)
                document.getElementById(`d${i}`).value = getConditionalRandom().toFixed(2)
            }
        }
    </script>
    <script>
        document.getElementById("calculate").addEventListener("click", function() {
        const formData = new FormData();

        // Собираем значения L1-L15 (startValues) как числа
        const startValues = [];
        for (let i = 1; i <= 15; i++) {
            const value = parseFloat(document.getElementById(`L${i}`).value) || 0;
            startValues.push(value);
        }
        formData.append('startValues', JSON.stringify(startValues));

        // Собираем значения L1-L15 MAX (maxValues) как числа
        const maxValues = [];
        for (let i = 1; i <= 15; i++) {
            const value = parseFloat(document.getElementById(`L${i}_max`).value) || 0;
            maxValues.push(value);
        }
        formData.append('maxValues', JSON.stringify(maxValues));

        // Собираем значения L1-L15 norm (normValues) как числа
        const normValues = [];
        for (let i = 1; i <= 15; i++) {
            const value = parseFloat(document.getElementById(`L${i}_norm`).value) || 0;
            normValues.push(value);
        }
        formData.append('normValues', JSON.stringify(normValues));

        // Собираем коэффициенты уравнений a1, b1, c1, d1 и т.д. как числа
        const qcoefs = [];
        for (let i = 1; i <= 4; i++) {
            const qa = parseFloat(document.getElementById(`qa${i}`).value) || 0;
            const qb = parseFloat(document.getElementById(`qb${i}`).value) || 0;
            const qc = parseFloat(document.getElementById(`qc${i}`).value) || 0;
            const qd = parseFloat(document.getElementById(`qd${i}`).value) || 0;
            qcoefs.push([qa, qb, qc, qd]);
        }
        formData.append('qcoefs', JSON.stringify(qcoefs));

        // Собираем коэффициенты уравнений a1, b1, c1, d1 и т.д. как числа
        const coefs = [];
        for (let i = 1; i <= 55; i++) {
            const a = parseFloat(document.getElementById(`a${i}`).value) || 0;
            const b = parseFloat(document.getElementById(`b${i}`).value) || 0;
            const c = parseFloat(document.getElementById(`c${i}`).value) || 0;
            const d = parseFloat(document.getElementById(`d${i}`).value) || 0;
            coefs.push([a, b, c, d]);
        }
        formData.append('coefs', JSON.stringify(coefs));

        fetch("/calculate/", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById("results");

            // Форматируем новый результат
            const newResult = `
                <div class="result-item">
                    <img src="data:image/png;base64,${data.image1}" alt="График 1">
                    <img src="data:image/png;base64,${data.image2}" alt="График 2">
                </div>
            `;

            // Заменяем содержимое на новый результат
            resultDiv.innerHTML = newResult;

            // Работа с localStorage (можно оставить, если нужно сохранять только последний результат)
            const savedResults = JSON.parse(localStorage.getItem("savedResults")) || { results: [] };

            // Добавляем новое изображение в localStorage
            savedResults.results = [{ img1: data.image1, img2: data.image2 }];

            // Сохраняем обновленный список в localStorage
            localStorage.setItem("savedResults", JSON.stringify(savedResults));
        })
        .catch(error => console.error('Ошибка:', error));
    });
    </script>
    <script>
        document.getElementById("saveValuesToJson").addEventListener("click", function saveToJson() {
            // Собираем значения L1-L15 (startValues) как числа
            const startValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}`).value) || 0;
                startValues.push(value);
            }

            // Собираем значения L1-L15 MAX (maxValues) как числа
            const maxValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}_max`).value) || 0;
                maxValues.push(value);
            }

            // Собираем значения L1-L15 norm (normValues) как числа
            const normValues = [];
            for (let i = 1; i <= 15; i++) {
                const value = parseFloat(document.getElementById(`L${i}_norm`).value) || 0;
                normValues.push(value);
            }

            // Собираем коэффициенты уравнений a1, b1, c1, d1 и т.д. как числа
            const qcoefs = [];
            for (let i = 1; i <= 4; i++) {
                const a = parseFloat(document.getElementById(`qa${i}`).value) || 0;
                const b = parseFloat(document.getElementById(`qb${i}`).value) || 0;
                const c = parseFloat(document.getElementById(`qc${i}`).value) || 0;
                const d = parseFloat(document.getElementById(`qd${i}`).value) || 0;
                coefs.push([a, b, c, d]);
            }

            // Собираем коэффициенты уравнений a1, b1, c1, d1 и т.д. как числа
            const coefs = [];
            for (let i = 1; i <= 55; i++) {
                const a = parseFloat(document.getElementById(`a${i}`).value) || 0;
                const b = parseFloat(document.getElementById(`b${i}`).value) || 0;
                const c = parseFloat(document.getElementById(`c${i}`).value) || 0;
                const d = parseFloat(document.getElementById(`d${i}`).value) || 0;
                coefs.push([a, b, c, d]);
            }

            // Создаем объект для сохранения
            const data = {
                startValues,
                maxValues,
                coefs,
                qcoefs,
                normValues
            };

            // Преобразуем объект в JSON строку
            const jsonData = JSON.stringify(data, null, 2);

            // Создаем Blob и ссылку для скачивания
            const blob = new Blob([jsonData], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            // Создаем временную ссылку и инициируем скачивание
            const a = document.createElement("a");
            a.href = url;
            a.download = "data.json"; // Название файла
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        })
    </script>
    <script>
        function loadFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const jsonData = JSON.parse(e.target.result);

                // Заполнение значений в полях
                jsonData.startValues.forEach((value, index) => {
                    document.getElementById(`L${index + 1}`).value = value;
                });

                jsonData.maxValues.forEach((value, index) => {
                    document.getElementById(`L${index + 1}_max`).value = value;
                });

                jsonData.normValues.forEach((value, index) => {
                    document.getElementById(`L${index + 1}_norm`).value = value;
                });

                jsonData.coefs.forEach((coef, index) => {
                    document.getElementById(`a${index + 1}`).value = coef[0];
                    document.getElementById(`b${index + 1}`).value = coef[1];
                    document.getElementById(`c${index + 1}`).value = coef[2];
                    document.getElementById(`d${index + 1}`).value = coef[3];
                });

                jsonData.qcoefs.forEach((coef, index) => {
                    document.getElementById(`qa${index + 1}`).value = coef[0];
                    document.getElementById(`qb${index + 1}`).value = coef[1];
                    document.getElementById(`qc${index + 1}`).value = coef[2];
                    document.getElementById(`qd${index + 1}`).value = coef[3];
                });

                // Удаляем временный input
                event.target.remove();
            };

            reader.readAsText(file);
        }
        document.getElementById('loadValuesFromJson').addEventListener('click', function() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.onchange = loadFromJson;
            fileInput.style.width = 0;
            document.body.appendChild(fileInput); // Добавляем в DOM, чтобы его можно было использовать
            fileInput.click();
        });
    </script>
</body>

</html>
